<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!--
  ~  This file is part of Waltz.
  ~
  ~     Waltz is free software: you can redistribute it and/or modify
  ~     it under the terms of the GNU General Public License as published by
  ~     the Free Software Foundation, either version 3 of the License, or
  ~     (at your option) any later version.
  ~
  ~     Waltz is distributed in the hope that it will be useful,
  ~     but WITHOUT ANY WARRANTY; without even the implied warranty of
  ~     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  ~     GNU General Public License for more details.
  ~
  ~     You should have received a copy of the GNU General Public License
  ~     along with Waltz.  If not, see <http://www.gnu.org/licenses/>.
  -->

<databaseChangeLog xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd"
                   logicalFilePath="db.changelog-1.0.xml">

    <property name="clob.type" value="clob" dbms="oracle"></property>
    <property name="clob.type" value="text" dbms="mssql"></property>
    <property name="clob.type" value="longtext" dbms="mysql"></property>

    <property name="now.value" value="current_timestamp" dbms="oracle"></property>
    <property name="now.value" value="getutcdate()" dbms="mssql"></property>
    <property name="now.value" value="now()" dbms="mysql"></property>

    <property name="today.value" value="current_date" dbms="oracle"></property>
    <property name="today.value" value="getutcdate()" dbms="mssql"></property>
    <property name="today.value" value="curdate" dbms="mysql"></property>

    <property name="long.type" value="NUMBER(18)" dbms="oracle"></property>
    <property name="long.type" value="BIGINT" dbms="mssql"></property>
    <property name="long.type" value="BIGINT" dbms="mysql"></property>

    <property name="int.type" value="NUMBER(9)" dbms="oracle"></property>
    <property name="int.type" value="int" dbms="mssql"></property>
    <property name="int.type" value="INTEGER" dbms="mysql"></property>

    <property name="longvarchar.type" value="nvarchar(4000)" dbms="mssql"></property>
    <property name="longvarchar.type" value="LONGVARCHAR" dbms="mysql"></property>

    <!-- TABLES -->
    <changeSet author="dwatkins" id="20151129-tbl-1">
        <createTable tableName="access_log">
            <column autoIncrement="true" name="id" type="SERIAL">
                <constraints primaryKey="true" primaryKeyName="access_log_pkey"/>
            </column>
            <column name="user_id" type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="state" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="params" type="VARCHAR(1024)"/>
            <column defaultValueComputed="${now.value}" name="created_at" type="TIMESTAMP"/>
        </createTable>
    </changeSet>

    <changeSet author="dwatkins" id="20151129-tbl-2">
        <createTable tableName="app_capability">
            <column name="application_id" type="${long.type}">
                <constraints nullable="false"/>
            </column>
            <column name="capability_id" type="${long.type}">
                <constraints nullable="false"/>
            </column>
            <column defaultValueBoolean="false" name="is_primary" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="dwatkins" id="20151129-tbl-3">
        <createTable tableName="application">
            <column autoIncrement="true" name="id" type="BIGSERIAL">
                <constraints primaryKey="true" primaryKeyName="application_pkey"/>
            </column>
            <column name="name" type="VARCHAR(255)"/>
            <column name="description" type="${longvarchar.type}"/>
            <column name="asset_code" type="VARCHAR(255)"/>
            <column defaultValueComputed="${now.value}" name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="organisational_unit_id" type="${long.type}">
                <constraints nullable="false"/>
            </column>
            <column defaultValue="IN_HOUSE" name="kind" type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column defaultValue="PRODUCTION" name="lifecycle_phase" type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="parent_asset_code" type="VARCHAR(255)"/>
        </createTable>
    </changeSet>

    <changeSet author="dwatkins" id="20151129-tbl-4">
        <createTable tableName="authoritative_source">
            <column autoIncrement="true" name="id" type="BIGSERIAL">
                <constraints primaryKey="true" primaryKeyName="authoritative_source_pkey"/>
            </column>
            <column name="parent_kind" type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="data_type" type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="parent_id" type="${long.type}">
                <constraints nullable="false"/>
            </column>
            <column name="application_id" type="${long.type}">
                <constraints nullable="false"/>
            </column>
            <column name="rating" type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="dwatkins" id="20151129-tbl-5">
        <createTable tableName="bookmark">
            <column autoIncrement="true" name="id" type="BIGSERIAL">
                <constraints primaryKey="true" primaryKeyName="bookmark_pkey"/>
            </column>
            <column name="title" type="VARCHAR(255)"/>
            <column name="description" type="VARCHAR(255)"/>
            <column name="kind" type="VARCHAR(255)"/>
            <column name="url" type="VARCHAR(255)"/>
            <column name="parent_kind" type="VARCHAR(255)"/>
            <column name="parent_id" type="${long.type}"/>
            <column name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column defaultValueBoolean="false" name="is_primary" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="dwatkins" id="20151129-tbl-6">
        <createTable tableName="capability">
            <column name="id" type="${long.type}">
                <constraints nullable="false"/>
            </column>
            <column name="parent_id" type="${long.type}"/>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="${longvarchar.type}">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="dwatkins" id="20151129-tbl-7">
        <createTable tableName="change_log">
            <column autoIncrement="true" name="id" type="SERIAL">
                <constraints primaryKey="true" primaryKeyName="change_log_pkey"/>
            </column>
            <column name="parent_kind" type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="parent_id" type="${long.type}">
                <constraints nullable="false"/>
            </column>
            <column name="message" type="${longvarchar.type}">
                <constraints nullable="false"/>
            </column>
            <column name="user_id" type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="severity" type="VARCHAR(32)">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${now.value}" name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="dwatkins" id="20151129-tbl-8">
        <createTable tableName="data_flow">
            <column name="source_entity_kind" type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="source_entity_id" type="${long.type}">
                <constraints nullable="false"/>
            </column>
            <column name="target_entity_kind" type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="target_entity_id" type="${long.type}">
                <constraints nullable="false"/>
            </column>
            <column name="data_type" type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="dwatkins" id="20151129-tbl-9">
        <createTable tableName="data_type">
            <column name="code" type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(256)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="${longvarchar.type}">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="dwatkins" id="20151129-tbl-10">
        <createTable tableName="involvement">
            <column name="entity_kind" type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="entity_id" type="${long.type}">
                <constraints nullable="false"/>
            </column>
            <column name="kind" type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="employee_id" type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="dwatkins" id="20151129-tbl-11">
        <createTable tableName="organisational_unit">
            <column name="id" type="${long.type}">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(255)"/>
            <column name="description" type="${longvarchar.type}"/>
            <column name="kind" type="VARCHAR(255)"/>
            <column name="parent_id" type="${long.type}"/>
            <column defaultValueComputed="${now.value}" name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="dwatkins" id="20151129-tbl-12">
        <createTable tableName="person">
            <column autoIncrement="true" name="id" type="BIGSERIAL">
                <constraints primaryKey="true" primaryKeyName="person_pkey"/>
            </column>
            <column name="employee_id" type="VARCHAR(128)"/>
            <column name="display_name" type="VARCHAR(255)"/>
            <column name="email" type="VARCHAR(255)"/>
            <column name="user_principal_name" type="VARCHAR(255)"/>
            <column name="department_name" type="VARCHAR(255)"/>
            <column name="kind" type="VARCHAR(255)"/>
            <column name="manager_employee_id" type="VARCHAR(128)"/>
            <column name="title" type="VARCHAR(255)"/>
            <column name="office_phone" type="VARCHAR(128)"/>
            <column name="mobile_phone" type="VARCHAR(128)"/>
        </createTable>
    </changeSet>

    <changeSet author="dwatkins" id="20151129-tbl-13">
        <createTable tableName="person_hierarchy">
            <column name="manager_id" type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="employee_id" type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column defaultValueNumeric="99" name="level" type="${int.type}">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="dwatkins" id="20151129-tbl-14">
        <createTable tableName="perspective">
            <column defaultValue="BUSINESS" name="code" type="VARCHAR(32)">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="${longvarchar.type}">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="dwatkins" id="20151129-tbl-15">
        <createTable tableName="perspective_measurable">
            <column defaultValue="" name="code" type="VARCHAR(32)">
                <constraints nullable="false"/>
            </column>
            <column name="perspective_code" type="VARCHAR(32)">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="${longvarchar.type}">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="dwatkins" id="20151129-tbl-16">
        <createTable tableName="perspective_rating">
            <column name="measure_code" type="VARCHAR(32)">
                <constraints nullable="false"/>
            </column>
            <column defaultValue="Z" name="rating" type="CHAR(1)">
                <constraints nullable="false"/>
            </column>
            <column defaultValue="APPLICATION" name="parent_kind" type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="parent_id" type="${long.type}">
                <constraints nullable="false"/>
            </column>
            <column name="capability_id" type="${long.type}"/>
            <column defaultValue="BUSINESS" name="perspective_code" type="VARCHAR(32)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="dwatkins" id="20151129-tbl-17">
        <createTable tableName="server_information">
            <column autoIncrement="true" name="id" type="SERIAL">
                <constraints primaryKey="true" primaryKeyName="server_information_pkey"/>
            </column>
            <column name="hostname" type="VARCHAR(256)">
                <constraints nullable="false"/>
            </column>
            <column defaultValue="UNKNOWN" name="operating_system" type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column defaultValue="DEV" name="environment" type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="location" type="VARCHAR(128)"/>
            <column name="asset_code" type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="dwatkins" id="20151129-tbl-18">
        <createTable tableName="software_directory">
            <column autoIncrement="true" name="id" type="SERIAL">
                <constraints primaryKey="true" primaryKeyName="software_directory_pkey"/>
            </column>
            <column name="vendor" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="version" type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column defaultValue="HOLD" name="adoption_status" type="VARCHAR(64)">
                <constraints nullable="false"/>
            </column>
            <column defaultValueBoolean="false" name="notable" type="BOOLEAN"/>
            <column name="description" type="${longvarchar.type}"/>
        </createTable>
    </changeSet>

    <changeSet author="dwatkins" id="20151129-tbl-19">
        <createTable tableName="user">
            <column name="user_name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="password" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="dwatkins" id="20151129-tbl-20">
        <createTable tableName="user_role">
            <column name="user_name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="role" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="dwatkins" id="20151130-tbl-1">
        <createTable tableName="application_alias">
            <column name="application_id" type="${long.type}">
                <constraints nullable="false"/>
            </column>
            <column name="alias" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="dwatkins" id="20151130-tbl-2">
        <createTable tableName="application_tag">
            <column name="application_id" type="${long.type}">
                <constraints nullable="false"/>
            </column>
            <column name="tag" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>


    <!-- PRIMARY KEYS -->
    <changeSet author="dwatkins" id="20151129-pk-21">
        <addPrimaryKey columnNames="application_id, capability_id" constraintName="app_capability_pkey" tableName="app_capability"/>
    </changeSet>

    <changeSet author="dwatkins" id="20151129-pk-22">
        <addPrimaryKey columnNames="id" constraintName="capability_pkey" tableName="capability"/>
    </changeSet>

    <changeSet author="dwatkins" id="20151129-pk-23">
        <addPrimaryKey columnNames="source_entity_kind, source_entity_id, target_entity_id, target_entity_kind, data_type" constraintName="data_flow_pkey" tableName="data_flow"/>
    </changeSet>

    <changeSet author="dwatkins " id="20151129-pk-24">
        <addPrimaryKey columnNames="code" constraintName="data_type_pkey" tableName="data_type"/>
    </changeSet>

    <changeSet author="dwatkins" id="20151129-pk-25">
        <addPrimaryKey columnNames="id" constraintName="organisational_unit_pkey" tableName="organisational_unit"/>
    </changeSet>

    <changeSet author="dwatkins" id="20151129-pk-26">
        <addPrimaryKey columnNames="code" constraintName="perspective_measure_pkey" tableName="perspective_measurable"/>
    </changeSet>

    <changeSet author="dwatkins" id="20151129-pk-27">
        <addPrimaryKey columnNames="code" constraintName="perspective_pkey" tableName="perspective"/>
    </changeSet>

    <changeSet author="dwatkins" id="20151129-pk-28">
        <addPrimaryKey columnNames="manager_id, employee_id" constraintName="reportee_pkey" tableName="person_hierarchy"/>
    </changeSet>

    <changeSet author="dwatkins" id="20151129-pk-29">
        <addPrimaryKey columnNames="user_name" constraintName="user_pkey" tableName="user"/>
    </changeSet>

    <changeSet author="dwatkins" id="20151130-pk-1">
        <addPrimaryKey columnNames="application_id, alias" constraintName="application_alias_pkey" tableName="application_alias"/>
    </changeSet>

    <changeSet author="dwatkins" id="20151130-pk-2">
        <addPrimaryKey columnNames="application_id, tag" constraintName="application_tag_pkey" tableName="application_tag"/>
    </changeSet>


    <!-- UNIQUE CONSTRAINTS -->
    <changeSet author="dwatkins" id="20151129-uc-30">
        <addUniqueConstraint columnNames="employee_id" constraintName="unique_employee_id" tableName="person"/>
    </changeSet>


    <!-- INDEXES -->
    <changeSet author="dwatkins" id="20151129-idx-31">
        <createIndex indexName="fki_authoritative_source_application_id_fkey" tableName="authoritative_source">
            <column name="application_id"/>
        </createIndex>
    </changeSet>
    <changeSet author="dwatkins" id="20151129-idx-35">
        <createIndex indexName="unique_name" tableName="application" unique="true">
            <column name="name"/>
        </createIndex>
    </changeSet>


    <!-- FOREIGN KEYS -->
    <changeSet author="dwatkins" id="20151129-fk-36">
        <addForeignKeyConstraint baseColumnNames="organisational_unit_id"
                                 baseTableName="application"
                                 constraintName="application_organisational_unit_id_fkey"
                                 deferrable="false"
                                 initiallyDeferred="false"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="id"
                                 referencedTableName="organisational_unit"/>
    </changeSet>
    <changeSet author="dwatkins" id="20151129-fk-37">
        <addForeignKeyConstraint baseColumnNames="application_id"
                                 baseTableName="authoritative_source"
                                 constraintName="authoritative_source_application_id_fkey"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION"
                                 onUpdate="NO ACTION"
                                 referencedColumnNames="id"
                                 referencedTableName="application"/>
    </changeSet>


    <!-- REF DATA -->
    <changeSet id="20151129-rd-1" author="dwatkins">
        <insert tableName="user">
            <column name="user_name" value="admin"/>
            <column name="password" value="$2a$10$jN2VHmBjjKeb8fqDwZbvxecv8xGkVqOghAjUF68Xp0o2hHFhFHxou"/>
        </insert>
        <insert tableName="user_role">
            <column name="user_name" value="admin"/>
            <column name="role" value="ADMIN"/>
        </insert>
    </changeSet>

    <changeSet id="20151129-rd-2" author="dwatkins">
        <insert tableName="perspective">
            <column name="code" value="BUSINESS"></column>
            <column name="name" value="Business"></column>
            <column name="description" value="Business Perspective"></column>
        </insert>
        <insert tableName="perspective_measurable">
            <column name="code" value="FIC"></column>
            <column name="perspective_code" value="BUSINESS"></column>
            <column name="name" value="FIC"></column>
            <column name="description" value="Fixed Income"></column>
        </insert>
        <insert tableName="perspective_measurable">
            <column name="code" value="RATES"></column>
            <column name="perspective_code" value="BUSINESS"></column>
            <column name="name" value="Rates"></column>
            <column name="description" value="Rates and Currencies"></column>
        </insert>
        <insert tableName="perspective_measurable">
            <column name="code" value="EQ"></column>
            <column name="perspective_code" value="BUSINESS"></column>
            <column name="name" value="Equities"></column>
            <column name="description" value="Equities"></column>
        </insert>
    </changeSet>


    <!-- AMMENDMENTS -->

    <changeSet author="dwatkins" id="20151130-mod-1">
        <dropNotNullConstraint columnDataType="VARCHAR(128)"
                               columnName="manager_employee_id"
                               tableName="person"/>
    </changeSet>

    <changeSet author="dwatkins" id="20151130-mod-2">
        <dropNotNullConstraint columnDataType="VARCHAR(128)"
                               columnName="mobile_phone"
                               tableName="person"/>
        <dropNotNullConstraint columnDataType="VARCHAR(128)"
                               columnName="office_phone"
                               tableName="person"/>
        <dropNotNullConstraint columnDataType="VARCHAR(255)"
                               columnName="title"
                               tableName="person"/>
    </changeSet>

    <changeSet author="dwatkins" id="20151130-mod-3" dbms="mysql">
        <sql> CREATE FULLTEXT INDEX people_content_ft_idx ON person (display_name, user_principal_name, title) </sql>
    </changeSet>

    <changeSet author="dwatkins" id="20151130-mod-4" dbms="mysql">
        <sql> CREATE FULLTEXT INDEX application_content_ft_idx ON application (name, description, asset_code, parent_asset_code) </sql>
    </changeSet>

    <changeSet author="dwatkins" id="20151130-mod-5" dbms="mysql">
        <sql> CREATE FULLTEXT INDEX capability_content_ft_idx ON capability (name, description) </sql>
    </changeSet>

    <changeSet author="dwatkins" id="20151130-mod-6" dbms="mysql">
        <sql> CREATE FULLTEXT INDEX organisational_unit_content_ft_idx ON organisational_unit (name, description) </sql>
    </changeSet>

    <!-- Additional Server Fields #120 -->
    <changeSet author="dwatkins" id="20151212-mod-1">
        <addColumn tableName="server_information">
            <column name="operating_system_version" type="varchar(128)"/>
            <column name="country" type="varchar(128)"/>
            <column name="is_virtual" type="boolean"/>
        </addColumn>
    </changeSet>

    <!-- End User Apps #125 -->
    <changeSet author="dwatkins" id="20151214-tbl-1">
        <createTable tableName="end_user_application">
            <column name="id" type="${long.type}">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="${longvarchar.type}">
                <constraints nullable="false"/>
            </column>
            <column defaultValue="MS_EXCEL" name="kind" type="varchar(128)">
                <constraints nullable="false"/>
            </column>
            <column defaultValue="PRODUCTION" name="lifecycle_phase" type="varchar(128)">
                <constraints nullable="false"/>
            </column>
            <column defaultValue="MEDIUM" name="risk_rating" type="varchar(128)">
                <constraints nullable="false"/>
            </column>
            <column name="organisational_unit_id" type="${long.type}">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint baseColumnNames="organisational_unit_id"
                                 baseTableName="end_user_application"
                                 constraintName="end_user_application_organisational_unit_id_fkey"
                                 deferrable="false"
                                 initiallyDeferred="false"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="id"
                                 referencedTableName="organisational_unit"/>

    </changeSet>

    <changeSet author="dwatkins" id="20151217-tbl-1">
        <createTable tableName="asset_cost">
            <column name="asset_code" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="year" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="kind" type="varchar(128)">
                <constraints nullable="false"/>
            </column>
            <column name="amount" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>
            <column name="currency" type="char(3)">
                <constraints nullable="false"/>
            </column>
        </createTable>

    </changeSet>

    <changeSet author="dwatkins" id="20151226-mod-1">
        <addColumn tableName="capability">
            <column name="level" type="${int.type}" defaultValueNumeric="1">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>


    <changeSet author="dwatkins" id="20151230-mod-1">
        <createIndex indexName="idx_asset_code"
                     tableName="application"
                     unique="false">
            <column name="asset_code" type="varchar(255)"/>
        </createIndex>
    </changeSet>

    <changeSet author="dwatkins" id="20160104-tbl-1">
        <createTable tableName="svg_diagram">
            <column autoIncrement="true" name="id" type="BIGSERIAL">
                <constraints primaryKey="true" primaryKeyName="svg_diagram_pkey"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="kind" type="varchar(128)">
                <constraints nullable="false"/>
            </column>
            <column name="priority" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="${clob.type}">
                <constraints nullable="false"/>
            </column>
            <column name="svg" type="${clob.type}">
                <constraints nullable="false"/>
            </column>
            <column name="key_property" type="varchar(64)">
                <constraints nullable="false"/>
            </column>
            <column name="product" type="varchar(64)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>


    <changeSet author="dwatkins" id="20160105-tbl-1">
        <modifyDataType tableName="svg_diagram"
                        columnName="svg"
                        newDataType="${clob.type}"/>
    </changeSet>


    <changeSet author="dwatkins" id="20160106-idx-1">
        <createIndex indexName="idx_organisational_unit_id"
                     tableName="application"
                     unique="false">
            <column name="organisational_unit_id" type="${long.type}"/>
        </createIndex>
    </changeSet>

    <!-- 146 -->
    <changeSet author="dwatkins" id="20160106-idx-2">
        <createIndex indexName="idx_capability_id"
                     tableName="app_capability"
                     unique="false">
            <column name="capability_id" type="${long.type}"/>
        </createIndex>
        <createIndex indexName="idx_application_id"
                     tableName="app_capability"
                     unique="false">
            <column name="application_id" type="${long.type}"/>
        </createIndex>
    </changeSet>

    <!-- 146 -->
    <changeSet author="dwatkins" id="20160106-idx-3">
        <createIndex indexName="idx_asset_code"
                     tableName="server_information"
                     unique="false">
            <column name="asset_code" type="VARCHAR(128)"/>
        </createIndex>
    </changeSet>

    <!-- issue: 1 -->
    <changeSet author="dwatkins" id="20160122-issue-1">
        <addColumn tableName="application">
            <column defaultValue="Z" name="overall_rating" type="CHAR(1)">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>


    <!-- issue: 42 -->
    <changeSet author="dwatkins" id="20160205-tbl-1">
        <createTable tableName="static_panel">
            <column autoIncrement="true" name="id" type="BIGSERIAL">
                <constraints primaryKey="true" primaryKeyName="static_panel_pkey"/>
            </column>
            <column name="group" type="varchar(128)">
                <constraints nullable="false"/>
            </column>
            <column name="title" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="icon" type="varchar(64)" defaultValue="info">
                <constraints nullable="false"/>
            </column>
            <column name="priority" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="width" type="INTEGER" defaultValueNumeric="12">
                <constraints nullable="false"/>
            </column>
            <column name="kind" type="varchar(64)" defaultValue="HTML">
                <constraints nullable="false"/>
            </column>
            <column name="content" type="${clob.type}">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>


    <!-- issue: 43 -->
    <changeSet author="dwatkins" id="20160206-43-1">
        <createTable tableName="application_group">
            <column autoIncrement="true" name="id" type="BIGSERIAL">
                <constraints primaryKey="true" primaryKeyName="application_group_pkey"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="kind" type="varchar(64)" defaultValue="PUBLIC">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="${clob.type}">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="dwatkins" id="20160206-43-2">
        <createTable tableName="application_group_entry">
            <column name="group_id" type="${long.type}">
                <constraints nullable="false"/>
            </column>
            <column name="application_id" type="${long.type}">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="dwatkins" id="20160206-43-3">
        <createTable tableName="application_group_member">
            <column name="group_id" type="${long.type}">
                <constraints nullable="false"/>
            </column>
            <column name="user_id" type="varchar(128)">
                <constraints nullable="false"/>
            </column>
            <column name="role" type="varchar(64)" defaultValue="VIEWER">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>


    <changeSet author="dwatkins"
               id="20160212-43-3">
        <addPrimaryKey columnNames="group_id, application_id"
                       constraintName="application_group_entry_pkey"
                       tableName="application_group_entry"/>
    </changeSet>


    <changeSet author="dwatkins"
               id="20160213-43-1">
        <addPrimaryKey columnNames="group_id, user_id"
                       constraintName="application_group_member_pkey"
                       tableName="application_group_member"/>
    </changeSet>

    <changeSet author="dwatkins"
               id="20160214-43-1">
        <addForeignKeyConstraint baseColumnNames="group_id"
                                 baseTableName="application_group_member"
                                 constraintName="application_group_member_group_id_fkey"
                                 onDelete="CASCADE"
                                 referencedColumnNames="id"
                                 referencedTableName="application_group"/>

        <addForeignKeyConstraint baseColumnNames="group_id"
                                 baseTableName="application_group_entry"
                                 constraintName="application_group_entry_group_id_fkey"
                                 onDelete="CASCADE"
                                 referencedColumnNames="id"
                                 referencedTableName="application_group"/>

    </changeSet>


    <changeSet author="dwatkins"
               id="20160215-68-1">
        <addColumn tableName="application">
            <column name="provenance" type="varchar(64)" defaultValue="waltz">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn tableName="asset_cost">
            <column name="provenance" type="varchar(64)" defaultValue="waltz">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn tableName="authoritative_source">
            <column name="provenance" type="varchar(64)" defaultValue="waltz">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn tableName="bookmark">
            <column name="provenance" type="varchar(64)" defaultValue="waltz">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn tableName="end_user_application">
            <column name="provenance" type="varchar(64)" defaultValue="waltz">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn tableName="data_flow">
            <column name="provenance" type="varchar(64)" defaultValue="waltz">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn tableName="involvement">
            <column name="provenance" type="varchar(64)" defaultValue="waltz">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn tableName="server_information">
            <column name="provenance" type="varchar(64)" defaultValue="waltz">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet author="dwatkins"
               id="20160222-88-1">
        <addColumn tableName="capability">
            <column name="level_1" type="${long.type}">
                <constraints nullable="true"/>
            </column>
            <column name="level_2" type="${long.type}">
                <constraints nullable="true"/>
            </column>
            <column name="level_3" type="${long.type}">
                <constraints nullable="true"/>
            </column>
            <column name="level_4" type="${long.type}">
                <constraints nullable="true"/>
            </column>
            <column name="level_5" type="${long.type}">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet author="dwatkins" id="20160225-99-1">
        <createTable tableName="trait">
            <column autoIncrement="true" name="id" type="BIGSERIAL">
                <constraints primaryKey="true" primaryKeyName="trait_pkey"/>
            </column>
            <column name="name" type="varchar(128)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="varchar(255)" defaultValue="n/a">
                <constraints nullable="false"/>
            </column>
            <column name="icon" type="varchar(64)" defaultValue="circle">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>


    <changeSet author="dwatkins" id="20160225-99-2">
        <createTable tableName="trait_usage">
            <column name="entity_kind" type="varchar(128)">
                <constraints nullable="false"/>
            </column>
            <column name="entity_id" type="${long.type}">
                <constraints nullable="false"/>
            </column>
            <column name="relationship" type="varchar(32)">
                <constraints nullable="false"/>
            </column>
            <column name="trait_id" type="${long.type}">
                <constraints primaryKeyName="trait_usage_pkey"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="dwatkins" id="20160228-99-1">
        <addColumn tableName="trait">
            <column name="application_declarable"
                    type="boolean"
                    defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>


    <changeSet author="dwatkins"
               id="20160302-102-1">
        <dropDefaultValue tableName="application"
                          columnName="updated_at"/>
    </changeSet>

    <changeSet author="dwatkins"
               id="20160302-102-2">
        <dropDefaultValue tableName="organisational_unit"
                          columnName="updated_at"/>
    </changeSet>


    <changeSet author="dwatkins"
               dbms="mssql"
               id="20160317-105-1">
        <sql>
            CREATE FULLTEXT CATALOG WaltzFTS
            WITH ACCENT_SENSITIVITY = OFF;
        </sql>
    </changeSet>

    <changeSet author="dwatkins"
               dbms="mssql"
               id="20160317-105-2">
        <sql>
            CREATE FULLTEXT INDEX ON application
            (name, description, asset_code)
            KEY INDEX application_pkey
            ON WaltzFTS
            WITH STOPLIST = SYSTEM;
        </sql>
    </changeSet>

    <changeSet author="dwatkins"
               dbms="mssql"
               id="20160317-105-3">
        <sql>
            CREATE FULLTEXT INDEX ON capability
            (name, description)
            KEY INDEX capability_pkey
            ON WaltzFTS
            WITH STOPLIST = SYSTEM;
        </sql>
    </changeSet>


    <changeSet author="dwatkins"
               dbms="mssql"
               id="20160317-105-4">
        <sql>
            CREATE FULLTEXT INDEX ON person
            (display_name, title, email, user_principal_name, department_name)
            KEY INDEX person_pkey
            ON WaltzFTS
            WITH STOPLIST = SYSTEM;
        </sql>
    </changeSet>


    <changeSet author="dwatkins"
               dbms="mssql"
               id="20160317-105-5">
        <sql>
            CREATE FULLTEXT INDEX ON organisational_unit
            (name, description)
            KEY INDEX organisational_unit_pkey
            ON WaltzFTS
            WITH STOPLIST = SYSTEM;
        </sql>
    </changeSet>


    <!-- 120:SSO -->
    <changeSet author="dwatkins"
               id="20160330-120-1">
        <addForeignKeyConstraint baseColumnNames="user_name"
                                 baseTableName="user_role"
                                 constraintName="user_role_user_name_fkey"
                                 onDelete="CASCADE"
                                 referencedColumnNames="user_name"
                                 referencedTableName="user"/>
    </changeSet>


    <changeSet author="dwatkins" id="20160330-120-2">
        <createTable tableName="settings">
            <column name="name"
                    type="varchar(128)">
                <constraints nullable="false"/>
            </column>
            <column name="value"
                    type="varchar(255)">
                <constraints nullable="true"/>
            </column>
            <column name="restricted"
                    type="BOOLEAN"
                    defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="dwatkins" id="20160401-120-3">
        <insert tableName="settings">
            <column name="name" value="web.authentication"/>
            <column name="value" value="waltz"/>
            <column name="restricted" valueBoolean="false"/>
        </insert>
    </changeSet>

    <changeSet author="dwatkins" id="20160401-120-4">
        <insert tableName="settings">
            <column name="name" value="server.authentication.filter"/>
            <column name="value" value="com.khartec.waltz.web.endpoints.auth.JWTAuthenticationFilter"/>
            <column name="restricted" valueBoolean="false"/>
        </insert>
    </changeSet>

    <changeSet author="dwatkins" id="20160402-120-5">
        <addPrimaryKey columnNames="name"
                       constraintName="settings_pkey"
                       tableName="settings"/>
    </changeSet>

    <changeSet author="dwatkins" id="20160402-120-6">
        <insert tableName="settings">
            <column name="name" value="web.devext.enabled"/>
            <column name="value" value="false"/>
            <column name="restricted" valueBoolean="false"/>
        </insert>
    </changeSet>


    <!-- 128:Emp View Performance -->
    <changeSet author="dwatkins" id="20160408-128-1">
        <createIndex indexName="idx_involvement_entity_emp" tableName="involvement">
            <column name="entity_kind"/>
            <column name="entity_id"/>
            <column name="employee_id"/>
        </createIndex>
    </changeSet>


    <!-- 124:Adding org unit ref to person record -->
    <changeSet author="dwatkins" id="20160410-124-1">
        <addColumn tableName="person">
            <column name="organisational_unit_id"
                    type="${long.type}">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>



    <!-- 131: Software Catalog / Package -->
    <changeSet author="dwatkins" id="20160411-131-1">
        <dropTable tableName="software_directory"/>
    </changeSet>

    <changeSet author="dwatkins" id="20160411-131-2">
        <createTable tableName="software_package">
            <column autoIncrement="true"
                    name="id"
                    type="BIGSERIAL">
                <constraints primaryKey="true"
                             primaryKeyName="software_package_pkey"/>
            </column>
            <column name="vendor"
                    type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="name"
                    type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="version"
                    type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column defaultValue="HOLD"
                    name="maturity_status"
                    type="VARCHAR(64)">
                <constraints nullable="false"/>
            </column>
            <column defaultValueBoolean="false"
                    name="notable"
                    type="BOOLEAN"/>
            <column name="description"
                    type="${longvarchar.type}">
                <constraints nullable="true"/>
            </column>
            <column name="external_id"
                    type="varchar(64)"
                    defaultValue="waltz">
                <constraints nullable="true"/>
            </column>
            <column name="provenance"
                    type="varchar(64)"
                    defaultValue="waltz">
                <constraints nullable="false"/>
            </column>

        </createTable>
    </changeSet>

    <changeSet author="dwatkins" id="20160411-131-3">
        <createTable tableName="software_usage">
            <column name="application_id" type="${long.type}">
                <constraints nullable="false"/>
            </column>
            <column name="software_package_id" type="${long.type}">
                <constraints nullable="false"/>
            </column>
            <column name="provenance"
                    type="varchar(64)"
                    defaultValue="waltz">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="dwatkins" id="20160414-131-4">
        <insert tableName="settings">
            <column name="name" value="feature.software-catalog.enabled"/>
            <column name="value" value="true"/>
            <column name="restricted" valueBoolean="false"/>
        </insert>
    </changeSet>


    <!-- 134 Database -->

    <changeSet author="dwatkins"
               id="20160421-134-1">

        <createTable tableName="database">
            <column autoIncrement="true"
                    name="id"
                    type="BIGSERIAL">
                <constraints primaryKey="true"
                             primaryKeyName="database_usage_pkey"/>
            </column>

            <column name="database_name"
                    type="varchar(128)"
                    defaultValue="waltz">
                <constraints nullable="false"/>
            </column>
            <column name="instance_name"
                    type="varchar(128)"
                    defaultValue="waltz">
                <constraints nullable="false"/>
            </column>

            <column name="environment"
                    type="varchar(64)"
                    defaultValue="waltz">
                <constraints nullable="false"/>
            </column>


            <column name="dbms_vendor"
                    type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="dbms_name"
                    type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="dbms_version"
                    type="VARCHAR(128)">n
                <constraints nullable="false"/>
            </column>

            <column name="external_id"
                    type="varchar(64)"
                    defaultValue="waltz">
                <constraints nullable="true"/>
            </column>

            <column name="provenance"
                    type="varchar(64)"
                    defaultValue="waltz">
                <constraints nullable="false"/>
            </column>


        </createTable>
    </changeSet>


    <changeSet author="dwatkins"
               id="20160421-134-2">

        <createTable tableName="entity_relationship">
            <column name="kind_a"
                    type="varchar(128)">
                <constraints nullable="false"/>
            </column>
            <column name="id_a"
                    type="${long.type}">
                <constraints nullable="false"/>
            </column>
            <column name="kind_b"
                    type="varchar(128)">
                <constraints nullable="false"/>
            </column>
            <column name="id_b"
                    type="${long.type}">
                <constraints nullable="false"/>
            </column>
            <column name="relationship"
                    type="varchar(128)">
                <constraints nullable="false"/>
            </column>
            <column name="provenance"
                    type="varchar(64)"
                    defaultValue="waltz">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey columnNames="kind_a, id_a, kind_b, id_b, relationship"
                       constraintName="entity_relationship_pkey"
                       tableName="entity_relationship"/>

    </changeSet>

    <!-- 152:Creation of Source Data Ratings -->
    <changeSet author="dwatkins" id="20160518-152-1">
        <createTable tableName="source_data_rating">
            <column name="source_name"
                    type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="entity_kind"
                    type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column defaultValue="Z"
                    name="authoritativeness"
                    type="CHAR(1)">
                <constraints nullable="false"/>
            </column>
            <column defaultValue="Z"
                    name="accuracy"
                    type="CHAR(1)">
                <constraints nullable="false"/>
            </column>
            <column defaultValue="Z"
                    name="completeness"
                    type="CHAR(1)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey columnNames="source_name, entity_kind"
                       constraintName="source_data_rating_pkey"
                       tableName="source_data_rating"/>
    </changeSet>



    <!-- 154:ChangeIntiative -->
    <changeSet author="dwatkins" id="20160520-154-1">
        <createTable tableName="change_initiative">
            <column name="id"
                    type="${long.type}">
                <constraints nullable="false"/>
            </column>
            <column name="parent_id"
                    type="${long.type}">
                <constraints nullable="true"/>
            </column>
            <column name="external_id"
                    type="varchar(128)">
                <constraints nullable="true"/>
            </column>
            <column name="name"
                    type="varchar(128)">
                <constraints nullable="false"/>
            </column>
            <column name="kind"
                    type="varchar(64)"
                    defaultValue="PROGRAMME">
                <constraints nullable="false"/>
            </column>
            <column name="lifecycle_phase"
                    type="varchar(64)"
                    defaultValue="DEVELOPMENT">
                <constraints nullable="false"/>
            </column>
            <column name="description"
                    type="${longvarchar.type}">
                <constraints nullable="true"/>
            </column>
            <column name="last_update"
                    type="DATE">
                <constraints nullable="true"/>
            </column>
            <column name="start_date"
                    type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="end_date"
                    type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="provenance"
                    type="varchar(64)"
                    defaultValue="waltz">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey columnNames="id"
                       constraintName="change_initiative_pkey"
                       tableName="change_initiative"/>

    </changeSet>


    <changeSet author="dwatkins"
               id="20160520-154-2"
               dbms="mysql">
        <sql>
            CREATE FULLTEXT INDEX change_initiative_content_ft_idx ON change_initiative (name, description, external_id)
        </sql>
    </changeSet>


    <changeSet author="dwatkins"
               dbms="mssql"
               id="20160520-154-3">
        <sql>
            CREATE FULLTEXT INDEX ON change_initiative
            (name, description, external_id)
            KEY INDEX change_initiative_pkey
            ON WaltzFTS
            WITH STOPLIST = SYSTEM;
        </sql>
    </changeSet>



    <!-- 155: Import Job Log -->
    <changeSet author="dwatkins"
               id="20160523-155-1">
        <createTable tableName="system_job_log">
            <column name="name"
                    type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="entity_kind"
                    type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="status"
                    type="VARCHAR(64)">
                <constraints nullable="false"/>
            </column>
            <column name="description"
                    type="VARCHAR(2048)">
                <constraints nullable="true"/>
            </column>
            <column name="start"
                    type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="end"
                    type="TIMESTAMP">
                <constraints nullable="true"/>
            </column>
        </createTable>

        <addPrimaryKey columnNames="name, entity_kind, start"
                       constraintName="system_job_log_pkey"
                       tableName="system_job_log"/>
    </changeSet>


    <!-- 178: Precalc Complexity -->
    <changeSet author="dwatkins"
               id="20160526-178-1">
        <createTable tableName="complexity_score">
            <column name="entity_kind"
                    type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="entity_id"
                    type="${long.type}">
                <constraints nullable="false"/>
            </column>
            <column name="complexity_kind"
                    type="VARCHAR(64)">
                <constraints nullable="false"/>
            </column>
            <column name="score"
                    type="DECIMAL(10,3)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey columnNames="entity_kind, entity_id, complexity_kind"
                       constraintName="complexity_score_pkey"
                       tableName="complexity_score"/>
    </changeSet>


    <!-- 183: Performance Metrics -->
    <changeSet author="dwatkins"
               id="20160601-183-1">
        <createTable tableName="performance_metric_definition">
            <column name="id" type="${long.type}">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(255)"/>
            <column name="description" type="${longvarchar.type}"/>
            <column name="category_name" type="VARCHAR(255)"/>
            <column name="category_description" type="${longvarchar.type}"/>
        </createTable>

        <addPrimaryKey columnNames="id"
                       constraintName="performance_metric_defn_pkey"
                       tableName="performance_metric_definition"/>
    </changeSet>


    <changeSet author="dwatkins"
               id="20160602-183-2">
        <createTable tableName="perf_metric_pack">
            <column name="id" type="${long.type}">
                <constraints nullable="false"/>
            </column>
            <column name="name"
                    type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="description"
                    type="${longvarchar.type}">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey columnNames="id"
                       constraintName="perf_metric_pack_pkey"
                       tableName="perf_metric_pack"/>
    </changeSet>


    <changeSet author="dwatkins"
               id="20160602-183-3">
        <createTable tableName="perf_metric_pack_checkpoint">
            <column name="id"
                    type="${long.type}">
                <constraints nullable="false"/>
            </column>
            <column name="pack_id"
                    type="${long.type}">
                <constraints nullable="false"/>
            </column>

            <column name="year"
                    type="${int.type}">
                <constraints nullable="false"/>
            </column>
            <column name="quarter"
                    type="${int.type}">
                <constraints nullable="false"/>
            </column>
            <column name="name"
                    type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="description"
                    type="${longvarchar.type}">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey columnNames="id"
                       constraintName="perf_metric_pack_checkpoint_pk"
                       tableName="perf_metric_pack_checkpoint"/>
    </changeSet>


    <changeSet author="dwatkins"
               id="20160602-183-4">
        <dropPrimaryKey constraintName="performance_metric_defn_pkey"
                        tableName="performance_metric_definition"/>

        <renameTable newTableName="perf_metric_definition"
                     oldTableName="performance_metric_definition"/>


        <addPrimaryKey columnNames="id"
                       constraintName="perf_metric_definition_pkey"
                       tableName="perf_metric_definition"/>
    </changeSet>

    <changeSet author="dwatkins"
               id="20160602-183-5">
        <createTable tableName="perf_metric_pack_item">
            <column name="id"
                    type="${long.type}">
                <constraints nullable="false"/>
            </column>
            <column name="definition_id"
                    type="${long.type}">
                <constraints nullable="false"/>
            </column>
            <column name="section_name"
                    type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="baseline"
                    type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey columnNames="id"
                       constraintName="perf_metric_pack_item_pkey"
                       tableName="perf_metric_pack_item"/>
    </changeSet>


    <changeSet author="dwatkins"
               id="20160602-183-6">
        <createTable tableName="perf_metric_pack_item_goal">

            <column name="checkpoint_id"
                    type="${long.type}">
                <constraints nullable="false"/>
            </column>
            <column name="pack_item_id"
                    type="${long.type}">
                <constraints nullable="false"/>
            </column>
            <column name="kind"
                    type="VARCHAR(64)">
                <constraints nullable="false"/>
            </column>
            <column name="value" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey columnNames="checkpoint_id, pack_item_id"
                       constraintName="perf_metric_pack_item_goal_pk"
                       tableName="perf_metric_pack_item_goal"/>
    </changeSet>

    <changeSet id="20160602-183-7"
               author="dwatkins">
        <addColumn tableName="perf_metric_pack_item">
            <column name="pack_id"
                    type="${long.type}"/>
        </addColumn>
    </changeSet>

    <!-- 184 PROCESS -->

    <changeSet author="dwatkins" id="20160603-184-1">
        <createTable tableName="process">
            <column name="id" type="${long.type}">
                <constraints nullable="false"/>
            </column>
            <column name="parent_id" type="${long.type}">
                <constraints nullable="true"/>
            </column>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>

            <column name="level_1" type="${long.type}">
                <constraints nullable="false"/>
            </column>
            <column name="level_2" type="${long.type}">
                <constraints nullable="true"/>
            </column>
            <column name="level_3" type="${long.type}">
                <constraints nullable="true"/>
            </column>
            <column name="description" type="${longvarchar.type}">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="dwatkins" id="20160603-184-2">
        <addColumn tableName="process">
            <column name="level" type="${int.type}" defaultValueNumeric="1">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <!-- 190 NULLABLES -->

    <changeSet author="dwatkins" id="20160608-190-1">
        <dropNotNullConstraint columnDataType="${clob.type}"
                               columnName="description"
                               tableName="application_group"/>

    </changeSet>
    <changeSet author="dwatkins" id="20160608-190-2">
        <dropNotNullConstraint columnDataType="${longvarchar.type}"
                               columnName="description"
                               tableName="capability"/>
    </changeSet>

    <changeSet author="dwatkins" id="20160608-190-3">
        <dropNotNullConstraint columnDataType="${longvarchar.type}"
                               columnName="description"
                               tableName="data_type"/>
    </changeSet>

    <changeSet author="dwatkins" id="20160608-190-4">
        <dropNotNullConstraint columnDataType="${longvarchar.type}"
                               columnName="description"
                               tableName="end_user_application"/>
    </changeSet>

    <changeSet author="dwatkins" id="20160608-190-5">
        <dropNotNullConstraint columnDataType="${longvarchar.type}"
                               columnName="description"
                               tableName="perf_metric_pack"/>
    </changeSet>

    <changeSet author="dwatkins" id="20160608-190-6">
        <dropNotNullConstraint columnDataType="${longvarchar.type}"
                               columnName="description"
                               tableName="perf_metric_pack_checkpoint"/>
    </changeSet>

    <changeSet author="dwatkins" id="20160608-190-7">
        <dropNotNullConstraint columnDataType="${longvarchar.type}"
                               columnName="description"
                               tableName="perspective"/>
    </changeSet>

    <changeSet author="dwatkins" id="20160608-190-8">
        <dropNotNullConstraint columnDataType="${longvarchar.type}"
                               columnName="description"
                               tableName="perspective_measurable"/>
    </changeSet>

    <changeSet author="dwatkins" id="20160608-190-9">
        <dropNotNullConstraint columnDataType="${longvarchar.type}"
                               columnName="description"
                               tableName="process"/>
    </changeSet>

    <changeSet author="dwatkins" id="20160608-190-10">
        <dropNotNullConstraint columnDataType="${clob.type}"
                               columnName="description"
                               tableName="svg_diagram"/>
    </changeSet>

    <changeSet author="dwatkins" id="20160608-190-11">
        <dropNotNullConstraint columnDataType="VARCHAR(255)"
                               columnName="description"
                               tableName="trait"/>
    </changeSet>


    <!-- 185 PROVENANCE -->
    <changeSet author="dwatkins" id="20160608-185-1">

        <addColumn tableName="capability">
            <column name="provenance"
                    type="varchar(64)"
                    defaultValue="waltz">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn tableName="app_capability">
            <column name="provenance"
                    type="varchar(64)"
                    defaultValue="waltz">
                <constraints nullable="false"/>
            </column>
        </addColumn>

    </changeSet>


    <!-- 193 server_information - operating_system NULLABLE -->
    <changeSet author="dwatkins" id="20160609-193-1">
        <dropNotNullConstraint columnDataType="VARCHAR(128)"
                               columnName="operating_system"
                               tableName="server_information"/>

    </changeSet>


    <!-- 195 server_information - operating_system should NOT be nullable -->
    <changeSet author="dwatkins" id="20160613-195-1">
        <addNotNullConstraint columnDataType="VARCHAR(128)"
                              columnName="operating_system"
                              defaultNullValue="UNKNOWN"
                              tableName="server_information"/>
        <addNotNullConstraint columnDataType="VARCHAR(128)"
                              columnName="operating_system_version"
                              defaultNullValue="UNKNOWN"
                              tableName="server_information"/>
        <addNotNullConstraint columnDataType="VARCHAR(128)"
                              columnName="location"
                              defaultNullValue="UNKNOWN"
                              tableName="server_information"/>
        <addNotNullConstraint columnDataType="VARCHAR(128)"
                              columnName="country"
                              defaultNullValue="UNKNOWN"
                              tableName="server_information"/>
    </changeSet>

    <!-- last_import for source_data_rating #196 -->
    <changeSet author="dwatkins" id="20160614-196-1">
        	<addColumn tableName="source_data_rating">
            <column name="last_import"
                type="TIMESTAMP"
                defaultValueComputed="${now.value}">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>



    <!-- 214 permissions changes -->
    <changeSet author="dwatkins" id="20160617-214-1">
        <sql>
            UPDATE user_role
              SET role='ORG_UNIT_EDITOR'
              WHERE role='ORGUNIT_EDITOR';
        </sql>
    </changeSet>



    <!-- 222 last logins -->
    <changeSet author="dwatkins"
               id="20160620-222-1">
        <createTable tableName="user_agent_info">
            <column autoIncrement="true"
                    name="id"
                    type="SERIAL">
                <constraints primaryKey="true"
                             primaryKeyName="user_agent_info_pkey"/>
            </column>
            <column name="user_name"
                    type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="user_agent"
                    type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="resolution"
                    type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="operating_system"
                    type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="ip_address"
                    type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="login_timestamp"
                    type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <!-- 230 entity statistics -->
    <changeSet author="kamransaleem"
               id="20160621-230-1">
        <createTable tableName="entity_statistic">
            <column autoIncrement="true"
                    name="id"
                    type="BIGSERIAL">
                <constraints primaryKey="true"
                             primaryKeyName="entity_statistic_pkey"/>
            </column>
            <column name="name"
                    type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="description"
                    type="${longvarchar.type}">
                <constraints nullable="true"/>
            </column>
            <column name="type"
                    type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="category"
                    type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="active"
                    type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="renderer"
                    type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="historic_renderer"
                    type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="provenance"
                    type="varchar(64)"
                    defaultValue="waltz">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="kamransaleem"
               id="20160621-230-2">
        <createTable tableName="entity_statistic_value">
            <column autoIncrement="true"
                    name="id"
                    type="BIGSERIAL">
                <constraints primaryKey="true"
                             primaryKeyName="entity_statistic_value_pkey"/>
            </column>
            <column name="statistic_id"
                    type="${long.type}">
                <constraints nullable="false"/>
            </column>
            <column name="entity_kind"
                    type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="entity_id"
                    type="${long.type}">
                <constraints nullable="false"/>
            </column>
            <column name="value"
                    type="VARCHAR(128)">
                <constraints nullable="true"/>
            </column>
            <column name="outcome"
                    type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="state"
                    type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="reason"
                    type="${longvarchar.type}">
                <constraints nullable="true"/>
            </column>
            <column name="created_at"
                    type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="current"
                    type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="provenance"
                    type="varchar(64)"
                    defaultValue="waltz">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="kamransaleem"
               id="20160621-230-3">
        <createIndex indexName="idx_esv_statistic_id"
                     tableName="entity_statistic_value"
                     unique="false">
            <column name="statistic_id" type="${long.type}"/>
        </createIndex>
    </changeSet>

    <changeSet author="kamransaleem"
               id="20160621-230-4">
        <createIndex indexName="idx_esv_entity_ref"
                     tableName="entity_statistic_value"
                     unique="false">
            <column name="entity_kind" type="VARCHAR(128)"/>
            <column name="entity_id" type="${long.type}"/>
        </createIndex>
    </changeSet>

    <!-- 237 entity alias -->
    <changeSet author="dwatkins"
               id="20160623-237-1">
        <renameTable newTableName="entity_alias"
                     oldTableName="application_alias"/>
    </changeSet>


    <changeSet author="dwatkins"
               id="20160623-237-2">
        <renameColumn columnDataType="${long.type}"
                      newColumnName="id"
                      oldColumnName="application_id"
                      tableName="entity_alias"/>
    </changeSet>


    <changeSet author="dwatkins"
               id="20160623-237-3">
        <addColumn tableName="entity_alias">
            <column defaultValue="APPLICATION"
                    name="kind"
                    type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>


    <!-- 244 entity statistics - rename -->
    <changeSet author="kamransaleem"
               id="20160624-244-1"
               dbms="mssql">
        <renameTable newTableName="entity_statistic_definition"
                     oldTableName="entity_statistic"/>

        <dropPrimaryKey constraintName="entity_statistic_pkey"
                        tableName="entity_statistic_definition"/>

        <addPrimaryKey columnNames="id"
                       constraintName="entity_statistic_defn_pkey"
                       tableName="entity_statistic_definition"/>

    </changeSet>


    <changeSet author="kamransaleem"
               id="20160624-244-3"
               dbms="mysql">
        <renameTable newTableName="entity_statistic_definition"
                     oldTableName="entity_statistic"/>

        <sql>
            ALTER TABLE entity_statistic_definition
            DROP PRIMARY KEY,
            CHANGE id id bigint(20);
        </sql>

        <addPrimaryKey columnNames="id"
                       constraintName="entity_statistic_defn_pkey"
                       tableName="entity_statistic_definition"/>

    </changeSet>


    <!-- 251 Improve navigation of profile pages and add an index -->
    <changeSet author="dwatkins"
               id="20160628-251-1">
        <createIndex indexName="idx_change_log_user_id"
                     tableName="change_log"
                     unique="false">
            <column name="user_id"
                    type="VARCHAR(128)"/>
        </createIndex>
    </changeSet>


    <!-- 253 Record usage of data types by applications -->
    <changeSet author="dwatkins"
               id="20160629-253-1">
        <createTable tableName="data_type_usage">
            <column name="entity_kind"
                    type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="entity_id"
                    type="${long.type}">
                <constraints nullable="false"/>
            </column>
            <column name="data_type_code"
                    type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="usage_kind"
                    type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="description"
                    type="VARCHAR(2048)"
                    defaultValue="">
                <constraints nullable="false"/>
            </column>
            <column name="provenance"
                    type="varchar(64)"
                    defaultValue="waltz">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>


    <changeSet author="dwatkins"
               id="20160629-253-2">
        <addPrimaryKey columnNames="entity_kind, entity_id, data_type_code, usage_kind"
                       constraintName="data_type_usage_pkey"
                       tableName="data_type_usage"/>
    </changeSet>



    <changeSet author="dwatkins"
               id="20160629-253-3">
        <sql>
            INSERT INTO data_type_usage (entity_id, entity_kind, data_type_code, usage_kind)
                SELECT DISTINCT df.source_entity_id as entity_id, df.source_entity_kind as entity_kind, df.data_type as data_type_code, 'DISTRIBUTOR' as usage_kind
                FROM data_flow df
                    WHERE data_type != 'UNKNOWN'
                UNION ALL
                SELECT DISTINCT df.target_entity_id as entity_id, df.target_entity_kind as entity_kind, df.data_type as data_type_code, 'CONSUMER' as 'usage_kind'
                FROM data_flow df
                    WHERE data_type != 'UNKNOWN'
                UNION ALL
                SELECT DISTINCT df.source_entity_id as entity_id, df.source_entity_kind as entity_kind, df.data_type as data_type_code, 'ORIGINATOR' as 'usage_kind'
                FROM data_flow df
                    WHERE data_type != 'UNKNOWN'
                        AND NOT EXISTS(
                            SELECT *
                            FROM data_flow
                                WHERE target_entity_kind = df.source_entity_kind
                                    AND target_entity_id = df.source_entity_id
                                    AND data_type = df.data_type)
        </sql>
    </changeSet>


    <changeSet author="dwatkins"
               id="20160629-253-4">
        <addColumn tableName="data_type_usage">
            <column name="is_selected" type="boolean"/>
        </addColumn>
    </changeSet>

    <changeSet author="dwatkins"
               id="20160629-253-5">
        <sql>
            UPDATE data_type_usage SET is_selected = 1
        </sql>
    </changeSet>


    <!-- 302 - Entity Statistic Hierarchy -->
    <changeSet author="dwatkins"
               id="20160720-302-1">
        <addColumn tableName="entity_statistic_definition">
            <column name="parent_id"
                    type="${long.type}">
                <constraints nullable="true"></constraints>
            </column>
        </addColumn>

    </changeSet>


    <!-- 312 - Entit Stat Defn - Remove Auto Inc -->
    <changeSet author="dwatkins"
               id="2016072-312-1">
        <addColumn tableName="entity_statistic_definition">
            <column name="orig_id"
                    type="${long.type}">
                <constraints nullable="true"></constraints>
            </column>
        </addColumn>
    </changeSet>

    <changeSet author="dwatkins"
               id="2016072-312-2">
        <sql>
            UPDATE entity_statistic_definition SET orig_id = id
        </sql>
    </changeSet>


    <changeSet author="dwatkins"
               id="2016072-312-3">
        <dropPrimaryKey constraintName="entity_statistic_defn_pkey"
                        tableName="entity_statistic_definition"/>
    </changeSet>


    <changeSet author="dwatkins"
               id="2016072-312-4">
        <dropColumn tableName="entity_statistic_definition" columnName="id">
        </dropColumn>
    </changeSet>

    <changeSet author="dwatkins"
               id="2016072-312-5">
        <addColumn tableName="entity_statistic_definition">
            <column name="id" type="${long.type}">
            </column>
        </addColumn>
    </changeSet>

    <changeSet author="dwatkins"
               id="2016072-312-6">
        <sql>
            UPDATE entity_statistic_definition SET id = orig_id
        </sql>
    </changeSet>

    <changeSet author="dwatkins"
               id="2016072-312-7">
        <addNotNullConstraint tableName="entity_statistic_definition"
                              columnName="id"
                              columnDataType="${long.type}"/>
    </changeSet>

    <changeSet author="dwatkins"
               id="2016072-312-8">
        <addPrimaryKey columnNames="id"
                       constraintName="entity_statistic_defn_pkey"
                       tableName="entity_statistic_definition"/>
    </changeSet>

    <changeSet author="dwatkins"
               id="2016072-312-9">
        <dropColumn tableName="entity_statistic_definition"
                    columnName="orig_id">
        </dropColumn>
    </changeSet>


</databaseChangeLog>
