<div>


    <waltz-page-header icon="desktop"
                       name="{{ ctrl.app.name }}"
                       small="{{ ctrl.app.assetCode }}">
        <ol class="waltz-breadcrumbs">
            <li><a ui-sref="main">Home</a></li>
            <li>Waltz</li>
        </ol>
    </waltz-page-header>


    <!-- OVERVIEW -->
    <waltz-app-overview-section app='ctrl.app'
                                tags='ctrl.tags'
                                aliases='ctrl.aliases'
                                organisational-unit="ctrl.organisationalUnit"
                                complexity="ctrl.complexity"
                                update-aliases="ctrl.saveAliases(aliases)">
    </waltz-app-overview-section>


    <br>

    <!-- FUNCTIONS and RATINGS -->
    <waltz-section name="Functions and Ratings"
                   icon="puzzle-piece"
                   id="functions-ratings-section">

        <waltz-section-actions>
            <a waltz-has-role="RATING_EDITOR"
               ui-sref='main.app-capability.edit ({id: ctrl.app.id})'
               ng-if="ctrl.capabilityTab == 0"
               class="btn btn-xs btn-primary">
                Edit
            </a>
            <a waltz-has-role="RATING_EDITOR"
               ui-sref='main.ratings.editor ({kind : "APPLICATION", entityId: ctrl.app.id, perspectiveCode: "BUSINESS"})'
               ng-if="ctrl.capabilityTab == 1"
               class="btn btn-xs btn-primary">
                Edit
            </a>
            <button class="btn btn-xs waltz-btn-transparent"
                    ng-click="ctrl.visibility.overlay = ! ctrl.visibility.overlay">
                <waltz-icon name="map-signs"></waltz-icon>
            </button>
        </waltz-section-actions>

        <waltz-source-data-overlay visible="ctrl.visibility.overlay"
                                   ratings="ctrl.sourceDataRatings"
                                   entities="['APP_CAPABILITY']">
        </waltz-source-data-overlay>

        <uib-tabset active="active"
                    ng-init="ctrl.capabilityTab = 0">

            <!-- CAPABILITIES -->
            <uib-tab index="0"
                     select="ctrl.capabilityTab = 0"
                     heading="Functions">

                <waltz-app-capability-section app-capabilities="ctrl.appCapabilities"
                                              capabilities="ctrl.capabilities">
                </waltz-app-capability-section>
            </uib-tab>

            <!-- RATINGS -->
            <uib-tab index="1"
                     select="ctrl.capabilityTab = 1"
                     heading="Ratings">
                <div class="row"
                     ng-if="ctrl.capabilityTab == 1">
                    <div class="col-md-12">
                        <div ng-if="ctrl.appCapabilities.length > 0">
                            <waltz-rating-group-header measurables="ctrl.ratings.group.measurables">
                            </waltz-rating-group-header>

                            <waltz-rating-group tweakers="ctrl.ratings.tweakers"
                                                highest-rating-count="ctrl.ratings.highestRatingCount"
                                                data="ctrl.ratings.group"></waltz-rating-group>
                        </div>
                        <div ng-if="ctrl.appCapabilities.length == 0"
                             class="alert alert-warning">
                            <strong>No ratings</strong> - no ratings to show, as the application has not
                            declared it's functions.
                        </div>
                    </div>
                </div>
            </uib-tab>
        </uib-tabset>
    </waltz-section>


    <!-- BOOKMARKS -->
    <waltz-bookmarks-section bookmarks="ctrl.bookmarks"
                             entity-id="{{ ctrl.app.id }}"
                             kind="APPLICATION"
                             parent-name="{{ ctrl.app.name }}">
    </waltz-bookmarks-section>


    <!-- PROCESSES -->
    <waltz-process-section processes="ctrl.processes"
                           source-data-ratings="ctrl.sourceDataRatings">
    </waltz-process-section>


    <!-- INVOLVED PEOPLE -->
    <waltz-involved-people-section involvements="ctrl.peopleInvolvements"
                                   source-data-ratings="ctrl.sourceDataRatings">
    </waltz-involved-people-section>


    <!-- DATA TYPES & FLOWS -->
    <waltz-section name="Data"
                   icon="random"
                   small="( types and flows )"
                   id="data-types-flows-section">

        <waltz-section-actions>
            <a waltz-has-role="LOGICAL_DATA_FLOW_EDITOR"
               ng-if="ctrl.dataTab == 0"
               ui-sref='main.data-flow.edit ({kind:"APPLICATION", id: ctrl.app.id})'
               class="btn btn-xs btn-primary">
                Edit
            </a>


            <a class="btn btn-xs btn-primary"
               ui-sref="main.physical-flow.registration ({ kind: 'APPLICATION', id: ctrl.app.id })"
               ng-if="ctrl.dataTab == 1"
               waltz-has-role="LOGICAL_DATA_FLOW_EDITOR">
                Register
            </a>

            <div class="btn-group"
                 ng-if="ctrl.dataTab == 1"
                 uib-dropdown>

                 <button type="button"
                        ng-disabled="ctrl.physicalFlowsProducesCount == 0
                                        && ctrl.physicalFlowsConsumesCount == 0
                                        && ctrl.physicalFlowsUnusedSpecificationsCount == 0"
                        class="btn btn-xs btn-primary"
                        uib-dropdown-toggle>
                    Export <span class="caret"></span>
                </button>
                <ul class="dropdown-menu"
                    uib-dropdown-menu
                    style="min-width: 50px;"
                    role="menu">
                    <li role="menuitem">
                        <a href=""
                           ng-click="ctrl.exportPhysicalFlowProduces()"
                           ng-hide="ctrl.physicalFlowsProducesCount == 0"
                           class="small">
                            <waltz-icon name="download"></waltz-icon>
                            Produces
                        </a>
                    </li>
                    <li role="menuitem">
                        <a href=""
                           ng-click="ctrl.exportPhysicalFlowConsumes()"
                           ng-hide="ctrl.physicalFlowsConsumesCount == 0"
                           class="small">
                            <waltz-icon name="download"></waltz-icon>
                            Consumes
                        </a>
                    </li>
                    <li role="menuitem">
                        <a href=""
                           ng-click="ctrl.exportPhysicalFlowUnusedSpecifications()"
                           ng-hide="ctrl.physicalFlowsUnusedSpecificationsCount == 0"
                           class="small">
                            <waltz-icon name="download"></waltz-icon>
                            Unused
                        </a>
                    </li>
                </ul>
            </div>

            <button class="btn btn-xs waltz-btn-transparent"
                    ng-click="ctrl.visibility.logicalFlows = ! ctrl.visibility.logicalFlows">
                <waltz-icon name="map-signs"></waltz-icon>
            </button>
        </waltz-section-actions>

        <waltz-source-data-overlay visible="ctrl.visibility.logicalFlows"
                                   ratings="ctrl.sourceDataRatings"
                                   entities="['LOGICAL_DATA_FLOW', 'PHYSICAL_SPECIFICATION', 'PHYSICAL_FLOW']">
        </waltz-source-data-overlay>

        <uib-tabset active="active" ng-init="ctrl.dataTab = 0">
            <uib-tab index="0"
                     select="ctrl.dataTab = 0"
                     heading="Summary">
                <div ng-if="ctrl.dataTypeUsages.length == 0 && ctrl.flows.length == 0">
                    <div class="alert alert-warning"
                         ng-if="ctrl.dataTypeUsages.length == 0">
                        <strong>
                            No flows or types
                        </strong>
                        registered for this application.  Add them
                        <a ui-sref='main.data-flow.edit ({kind:"APPLICATION", id: ctrl.app.id})'>
                            here.
                        </a>
                    </div>
                </div>

                <div ng-if="ctrl.dataTypeUsages.length > 0 || ctrl.flows.length > 0">
                    <div class='row'>
                        <div class="col-md-12">
                            <h5>Data Types</h5>
                            <div class="alert alert-warning"
                                 ng-if="ctrl.dataTypeUsages.length == 0">
                                <strong>
                                    No Types
                                </strong>
                                registered for this application.  Add them
                                <a ui-sref='main.data-flow.edit ({kind:"APPLICATION", id: ctrl.app.id})'>
                                    here.
                                </a>
                            </div>

                            <waltz-app-data-type-usage-list usages="ctrl.dataTypeUsages"
                                                            ng-if="ctrl.dataTypeUsages.length > 0">
                            </waltz-app-data-type-usage-list>
                            <hr>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <h5>Logical Flows</h5>
                            <div class="alert alert-warning"
                                 ng-if="ctrl.flows.length == 0">
                                <strong>
                                    No Data Flows
                                </strong>
                                registered for this application.  Add one
                                <a ui-sref='main.data-flow.edit ({kind:"APPLICATION", id: ctrl.app.id})'>here</a>.
                            </div>

                            <div ng-if="ctrl.flows.length > 0">

                                <waltz-source-and-target-panel entity-ref="ctrl.entityRef"
                                                               logical-flows="ctrl.flows"
                                                               decorators="ctrl.dataFlowDecorators"
                                                               physical-flows="ctrl.physicalFlows"
                                                               physical-specifications="ctrl.physicalSpecifications">
                                </waltz-source-and-target-panel>

                                <p class="text-muted small">
                                    Diagram detailing the applications data types (Middle)
                                    from the sending system (LHS)
                                    to the receiving system on the (RHS).
                                    <span style="color: darkred">Red lines</span> indicate non-strategic flows,
                                    <span style="color: orange">Amber</span> indicates secondary and
                                    <span style="color: darkgreen">Green</span> indicates a primary system.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </uib-tab>
            <uib-tab index="1"
                     select="ctrl.dataTab = 1"
                     heading="Physical Flow Detail">
                <waltz-physical-data-section specifications="ctrl.physicalSpecifications"
                                             ng-if="ctrl.dataTab == 1"
                                             on-initialise="ctrl.onPhysicalFlowsInitialise"
                                             on-change="ctrl.onPhysicalFlowsChange"
                                             physical-flows="ctrl.physicalFlows">
                </waltz-physical-data-section>
            </uib-tab>
        </uib-tabset>

    </waltz-section>


    <!-- AUTH SOURCES -->
    <waltz-section name="Authoritative Flow Source"
                   ng-if="!(ctrl.authSources|isEmpty)"
                   id="authoritative-source-section">

        <p>
            This application has been declared as an authoritative source for some of the datatypes
            it deals with.
        </p>

        <div ng-repeat="(dataType, data) in ctrl.authSources"
             style="padding-top: 5px;">
            <h4 ng-bind="dataType | toDisplayName:'dataType'">
            </h4>
            <p class="text-muted"
               ng-bind="dataType | toDescription:'dataType'">
            </p>

            <table class="table table-condensed">
                <colgroup>
                    <col width="15%"/>
                    <col width="15%"/>
                    <col/>
                </colgroup>
                <tr ng-repeat="(rating, sources) in data">
                    <td>
                        <waltz-rating-indicator value="{{ rating }}">
                        </waltz-rating-indicator>
                    </td>
                    <td>
                        <span ng-bind="rating | toDisplayName:'rating'"></span>
                    </td>
                    <td>
                        Organisational Units:
                        <ul class="list-inline"
                            style="display: inline-block">
                            <li ng-repeat="source in sources">
                                <a ui-sref="main.org-unit.view({id: source.parentReference.id})"
                                   ng-bind="ctrl.orgUnitsById[source.parentReference.id].name">
                                </a>
                            </li>
                        </ul>
                    </td>
                </tr>
            </table>
        </div>
        <hr/>
        <small class="text-muted">
            The above table shows the datatypes this application is considered to be an authoritative source for.
            The classification of authoritativeness is from the viewpoint of an organisational unit (and its sub units)
            therefore you may see multiple declarations from different areas in the organisation.
        </small>

    </waltz-section>


    <!-- TECHNOLOGIES -->
    <div waltz-has-setting="feature.software-catalog.enabled=true">
        <waltz-technology-section software-catalog="ctrl.softwareCatalog"
                                  databases="ctrl.databases"
                                  servers="ctrl.servers">
        </waltz-technology-section>
    </div>


    <!-- COSTS -->
    <waltz-app-costs-section costs="ctrl.costs"
                             source-data-ratings="ctrl.sourceDataRatings">
    </waltz-app-costs-section>


    <!-- INDICATORS -->
    <waltz-entity-statistic-section name="Indicators"
                                    entity-statistics="ctrl.entityStatistics">
    </waltz-entity-statistic-section>


    <!-- CHANGE LOG -->
    <waltz-change-log-section entries="ctrl.log"
                              entity-reference="{ kind: 'APPLICATION', id: ctrl.app.id, name: ctrl.app.name }">
    </waltz-change-log-section>

</div>
